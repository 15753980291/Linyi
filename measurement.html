<!DOCTYPE html>
<html>

<head>
    <title>ä¸´æ²‚æ–‡æ—…-ç©ºé—´é‡ç®—ç³»ç»Ÿ</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        #viewDiv {
            width: 100%;
            height: 100vh;
        }

        /* å¼¹å‡ºæ¡†ç…§ç‰‡æ ·å¼ */
        .popup-content {
            display: flex;
            flex-direction: column;
            max-width: 100%;
            min-width: 250px;
        }

        .popup-photo {
            margin-bottom: 10px;
            text-align: center;
        }

        .popup-photo img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .popup-photo img:hover {
            transform: scale(1.05);
        }

        .popup-info {
            font-size: 14px;
        }

        .popup-info p {
            margin: 5px 0;
        }

        .loading-indicator {
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .no-photo {
            padding: 20px;
            color: #999;
            font-style: italic;
            background-color: #f5f5f5;
            border-radius: 5px;
        }

        .error-message {
            padding: 10px;
            color: #d9534f;
            background-color: #f9f2f2;
            border-radius: 5px;
        }

        .photo-gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }

        .attachment-photo {
            width: 120px;
            height: 120px;
            object-fit: cover;
            margin: 2px;
        }
 

        /* ç…§ç‰‡æ¨¡æ€æ¡†æ ·å¼ */
        .photo-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            padding-top: 50px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 80%;
        }

        #modalCaption {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
            text-align: center;
            color: white;
            padding: 10px 0;
            height: 150px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 999;
        }

        .control-btn {
            padding: 8px 12px;
            margin: 5px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .result-panel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        #instruction {
            margin-top: 10px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 13px;
        }
    </style>

</head>

<body>

    <div class="control-panel">
        <h3 style="margin-top:0;color:#1890ff">ç©ºé—´é‡ç®—å·¥å…·</h3>
        <button id="distanceBtn" class="control-btn">ğŸ“ è·ç¦»é‡ç®—</button>
        <button id="areaBtn" class="control-btn">ğŸ“ é¢ç§¯é‡ç®—</button>
        <button id="clearBtn" class="control-btn">ğŸ—‘ï¸ æ¸…é™¤</button>
        <button class="back-btn" onclick="window.history.back()">è¿”å›</button>
        <div id="instruction">è¯·é€‰æ‹©æµ‹é‡ç±»å‹å¼€å§‹æ“ä½œ</div>
    </div>
    <div id="viewDiv"></div>
    <div class="result-panel" id="resultPanel">
        <span style="color:#1890ff">ä¸´æ²‚æ–‡æ—…å¯¼èˆªç³»ç»Ÿ</span> | æµ‹é‡ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
    </div>
    <!-- ç…§ç‰‡æ¨¡æ€æ¡† -->
    <div id="photoModal" class="photo-modal">
        <span class="close-modal">&times;</span>
        <img id="modalImage" class="modal-content">
        <div id="modalCaption"></div>
    </div>

    <script src="https://js.arcgis.com/4.24/"></script>
    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/layers/GraphicsLayer",
            "esri/Graphic",
            "esri/geometry/Polyline",
            "esri/geometry/Polygon",
            "esri/geometry/support/webMercatorUtils",
            "esri/config",
            "esri/Basemap",
            "esri/layers/WebTileLayer",
            "esri/request"
        ], function (
            Map, MapView, FeatureLayer,
            GraphicsLayer, Graphic,
            Polyline, Polygon,
            webMercatorUtils, esriConfig,
            Basemap, WebTileLayer, esriRequest
        ) {
            // åˆ›å»ºé«˜å¾·åœ°å›¾ç“¦ç‰‡å›¾å±‚
            const gaodeLayer = new WebTileLayer({
                urlTemplate: "https://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}",
                copyright: "é«˜å¾·åœ°å›¾"
            });

            // åˆ›å»ºåº•å›¾å®ä¾‹
            const basemap = new Basemap({
                baseLayers: [gaodeLayer]
            });

            // åˆå§‹åŒ–åœ°å›¾
            const map = new Map({
                basemap: basemap
            });

            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [118.35646, 35.10333], // ä¸´æ²‚ä¸­å¿ƒåæ ‡
                zoom: 12
            });

            // è®¾ç½®ä»£ç†ï¼ˆå¦‚éœ€ï¼‰
            // esriConfig.request.proxyUrl = "/proxy/";

            // åŠ è½½GeoSceneæ™¯ç‚¹å›¾å±‚
            const attractionsLayer = new FeatureLayer({
                url: "https://www.geosceneonline.cn/server/rest/services/Hosted/ä¸´æ²‚æ™¯ç‚¹/FeatureServer",
                outFields: ["*"],
                popupTemplate: {
                    title: "{name}",
                    content: function(feature) {
                        // è·å–æ™¯ç‚¹å±æ€§
                        const attr = feature.graphic.attributes;
                        const name = attr.name || "æœªå‘½åæ™¯ç‚¹";
                        const objectId = attr.OBJECTID || attr.objectid;

                        // åˆ›å»ºå†…å®¹å®¹å™¨
                        const contentDiv = document.createElement("div");
                        contentDiv.className = "popup-content";

                        // åˆ›å»ºç…§ç‰‡å®¹å™¨
                        const photoDiv = document.createElement("div");
                        photoDiv.className = "popup-photo";
                        photoDiv.innerHTML = `<div class="loading-indicator">æ­£åœ¨åŠ è½½ç…§ç‰‡...</div>`;
                        contentDiv.appendChild(photoDiv);

                        // åˆ›å»ºä¿¡æ¯å®¹å™¨
                        const infoDiv = document.createElement("div");
                        infoDiv.className = "popup-info";
                        infoDiv.innerHTML = `
                            <p><strong>åœ°å€:</strong> ${attr.address || attr.addess || "æœªçŸ¥"}</p>
                            <p><strong>ç‰¹è‰²:</strong> ${attr.feature || "æœªçŸ¥"}</p>
                            <p><strong>æ™¯åŒºçº§åˆ«:</strong> ${attr.Grade || attr.grade || "æœªåˆ†çº§"}</p>
                            <p><strong>é—¨ç¥¨ä»·æ ¼:</strong> ${attr.rate || "å…è´¹"}</p>
                        `;
                        contentDiv.appendChild(infoDiv);

                        // æŸ¥è¯¢é™„ä»¶
                        if (objectId) {
                            console.log("è¦ç´ ID:", objectId);

                            // ä½¿ç”¨FeatureLayerçš„queryAttachmentsæ–¹æ³•æŸ¥è¯¢é™„ä»¶
                            attractionsLayer.queryAttachments({
                                objectIds: [objectId],
                                attachmentTypes: ["image/jpeg", "image/png", "image/gif"]
                            }).then(function(attachmentsByFeatureId) {
                                console.log("é™„ä»¶å“åº”:", attachmentsByFeatureId);

                                // æ£€æŸ¥æ˜¯å¦æœ‰é™„ä»¶
                                if (attachmentsByFeatureId && Object.keys(attachmentsByFeatureId).length > 0) {
                                    const attachments = attachmentsByFeatureId[objectId];

                                    if (attachments && attachments.length > 0) {
                                        const photoHtml = [];

                                        // åˆ›å»ºç…§ç‰‡å¹»ç¯ç‰‡å®¹å™¨
                                        photoHtml.push(`<div class="photo-gallery">`);

                                        // éå†æ‰€æœ‰é™„ä»¶
                                        attachments.forEach(function(attachment) {
                                            photoHtml.push(`<img src="${attachment.url}" alt="${name}" class="attachment-photo" onclick="showModal('${attachment.url}', '${name}')">`);
                                        });

                                        photoHtml.push(`</div>`);
                                        photoDiv.innerHTML = photoHtml.join("");
                                        return;
                                    }
                                }

                                // å¦‚æœæ²¡æœ‰é™„ä»¶ï¼Œæ˜¾ç¤ºæ²¡æœ‰ç…§ç‰‡çš„æç¤º
                                photoDiv.innerHTML = `<div class="no-photo">æš‚æ— ç…§ç‰‡</div>`;
                            }).catch(function(error) {
                                console.error("è·å–é™„ä»¶å¤±è´¥:", error);
                                photoDiv.innerHTML = `<div class="error-message">ç…§ç‰‡åŠ è½½å¤±è´¥</div>`;
                            });
                        } else {
                            photoDiv.innerHTML = `<div class="no-photo">æš‚æ— ç…§ç‰‡</div>`;
                        }

                        return contentDiv;
                    },
                    actions: [{
                        title: "ä»æ­¤ç‚¹å¼€å§‹æµ‹é‡",
                        id: "measure-from-here",
                        className: "esri-icon-measure-line"
                    }]
                }
            });
            map.add(attractionsLayer);

            // é‡æµ‹åŠŸèƒ½å®ç°
            const graphicsLayer = new GraphicsLayer();
            map.add(graphicsLayer);

            let measureMode = null;
            let measurePoints = [];
            let measureGraphic = null;

            // è·ç¦»é‡ç®—
            document.getElementById("distanceBtn").addEventListener("click", function () {
                resetMeasurement();
                measureMode = "distance";
                updateInstruction("ç‚¹å‡»åœ°å›¾é€‰æ‹©èµ·ç‚¹ï¼Œå†æ¬¡ç‚¹å‡»é€‰æ‹©ç»ˆç‚¹");
            });

            // é¢ç§¯é‡ç®—
            document.getElementById("areaBtn").addEventListener("click", function () {
                resetMeasurement();
                measureMode = "area";
                updateInstruction("ç‚¹å‡»æ·»åŠ é¡¶ç‚¹ï¼ŒåŒå‡»å®Œæˆç»˜åˆ¶");
            });

            // æ¸…é™¤
            document.getElementById("clearBtn").addEventListener("click", resetMeasurement);

            // åœ°å›¾ç‚¹å‡»äº‹ä»¶
            view.on("click", function (evt) {
                if (!measureMode) return;

                const point = webMercatorUtils.xyToLngLat(evt.mapPoint.x, evt.mapPoint.y);
                measurePoints.push(point);

                if (measureMode === "distance" && measurePoints.length === 2) {
                    completeDistanceMeasurement();
                } else if (measureMode === "area") {
                    updateAreaMeasurement();
                }
            });

            // åœ°å›¾åŒå‡»äº‹ä»¶ï¼ˆé¢ç§¯æµ‹é‡å®Œæˆï¼‰
            view.on("double-click", function () {
                if (measureMode === "area" && measurePoints.length >= 3) {
                    completeAreaMeasurement();
                }
            });

            // æ™¯ç‚¹ç‚¹å‡»äº‹ä»¶ï¼ˆæ”¯æŒç›´æ¥ç‚¹å‡»æ™¯ç‚¹æµ‹é‡ï¼‰
            view.popup.on("trigger-action", function (event) {
                if (event.action.id === "measure-from-here" && measureMode === "distance") {
                    const feature = view.popup.selectedFeature;
                    const point = [
                        feature.geometry.longitude,
                        feature.geometry.latitude
                    ];

                    measurePoints.push(point);
                    if (measurePoints.length === 1) {
                        updateInstruction("å·²é€‰æ‹©èµ·ç‚¹ï¼Œè¯·é€‰æ‹©ç»ˆç‚¹");
                    } else if (measurePoints.length === 2) {
                        completeDistanceMeasurement();
                    }
                }
            });

            // æ›´æ–°è·ç¦»æµ‹é‡
            function updateDistanceMeasurement() {
                graphicsLayer.remove(measureGraphic);

                if (measurePoints.length > 1) {
                    const polyline = new Polyline({
                        paths: [measurePoints],
                        spatialReference: { wkid: 4326 }
                    });

                    measureGraphic = new Graphic({
                        geometry: polyline,
                        symbol: {
                            type: "simple-line",
                            color: [56, 168, 0, 0.8],
                            width: 3
                        }
                    });
                    graphicsLayer.add(measureGraphic);

                    const distance = calculateDistance(measurePoints[0], measurePoints[1]);
                    updateResult(`è·ç¦»ï¼š${distance.toFixed(2)} ç±³`);
                }
            }

            // å®Œæˆè·ç¦»æµ‹é‡
            function completeDistanceMeasurement() {
                updateDistanceMeasurement();
                updateInstruction("è·ç¦»æµ‹é‡å®Œæˆ");
                measureMode = null;
            }

            // æ›´æ–°é¢ç§¯æµ‹é‡
            function updateAreaMeasurement() {
                graphicsLayer.remove(measureGraphic);

                if (measurePoints.length >= 3) {
                    const polygon = new Polygon({
                        rings: [measurePoints.concat([measurePoints[0]])], // é—­åˆå¤šè¾¹å½¢
                        spatialReference: { wkid: 4326 }
                    });

                    measureGraphic = new Graphic({
                        geometry: polygon,
                        symbol: {
                            type: "simple-fill",
                            color: [56, 168, 0, 0.3],
                            outline: {
                                color: [56, 168, 0, 0.8],
                                width: 2
                            }
                        }
                    });
                    graphicsLayer.add(measureGraphic);

                    const area = calculateArea(measurePoints);
                    updateResult(`é¢ç§¯ï¼š${area.toFixed(2)} å¹³æ–¹ç±³ (${(area / 666.67).toFixed(2)} äº©)`);
                }
            }

            // å®Œæˆé¢ç§¯æµ‹é‡
            function completeAreaMeasurement() {
                updateAreaMeasurement();
                updateInstruction("é¢ç§¯æµ‹é‡å®Œæˆ");
                measureMode = null;
            }

            // è®¡ç®—è·ç¦»ï¼ˆç±³ï¼‰
            function calculateDistance(point1, point2) {
                const R = 6371000; // åœ°çƒåŠå¾„
                const dLat = (point2[1] - point1[1]) * Math.PI / 180;
                const dLon = (point2[0] - point1[0]) * Math.PI / 180;
                const a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(point1[1] * Math.PI / 180) *
                    Math.cos(point2[1] * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            // è®¡ç®—é¢ç§¯ï¼ˆå¹³æ–¹ç±³ï¼‰
            function calculateArea(points) {
                let area = 0;
                const n = points.length;
                for (let i = 0; i < n; i++) {
                    const j = (i + 1) % n;
                    area += points[i][0] * points[j][1];
                    area -= points[j][0] * points[i][1];
                }
                return Math.abs(area) * 111319.488 * 111319.488 / 2; // ç»çº¬åº¦è½¬å¹³é¢è¿‘ä¼¼
            }

            // æ›´æ–°æ“ä½œæç¤º
            function updateInstruction(text) {
                document.getElementById("instruction").innerHTML =
                    `<span style="color:#1890ff">æ“ä½œæç¤ºï¼š</span>${text}`;
            }

            // æ›´æ–°ç»“æœå±•ç¤º
            function updateResult(text) {
                document.getElementById("resultPanel").innerHTML = `
                    <span style="color:#1890ff">ğŸ“ æµ‹é‡ç»“æœ</span><br>
                    ${text}
                `;
            }

            // é‡ç½®æµ‹é‡
            function resetMeasurement() {
                measureMode = null;
                measurePoints = [];
                graphicsLayer.removeAll();
                updateResult("è¯·é€‰æ‹©æµ‹é‡å·¥å…·å¼€å§‹æµ‹é‡");
                updateInstruction("è¯·é€‰æ‹©æµ‹é‡ç±»å‹");
            }

            // åˆå§‹åŒ–å¼¹çª—åŠ¨ä½œï¼ˆç”¨äºæ™¯ç‚¹ç›´æ¥æµ‹é‡ï¼‰
            // æ³¨æ„ï¼šæˆ‘ä»¬å·²ç»åœ¨popupTemplateä¸­å®šä¹‰äº†actions
        });

        // ç…§ç‰‡æ¨¡æ€æ¡†åŠŸèƒ½
        const modal = document.getElementById("photoModal");
        const modalImg = document.getElementById("modalImage");
        const captionText = document.getElementById("modalCaption");
        const closeModal = document.querySelector(".close-modal");

        // å…¨å±€å‡½æ•°ï¼Œç”¨äºæ˜¾ç¤ºæ¨¡æ€æ¡†
        window.showModal = function(imgSrc, caption) {
            modal.style.display = "block";
            modalImg.src = imgSrc;
            captionText.innerHTML = caption;
        }

        // ç‚¹å‡»å…³é—­æŒ‰é’®å…³é—­æ¨¡æ€æ¡†
        closeModal.onclick = function() {
            modal.style.display = "none";
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>

</html>